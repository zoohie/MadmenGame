# FrontEndFrameworkNodeModule

[Use bitbucket for hosting private npm modules](https://steemit.com/programming/@donmesswithabeer/use-bitbucket-for-hosting-private-npm-modules)

[Install npm package from bitbucket repo](https://community.atlassian.com/t5/Bitbucket-questions/How-can-I-install-an-npm-package-from-my-bitbucket-repository/qaq-p/752908)

**Before commit: npm run export**

**Required files for custom project:**
* tsconfig.json
* src/index.ts
* src/index.html

<h5>Install framework: npm i bitbucket:leapgaming/frontendframeworknodemodule[#branch|version|tag]</h5>

**In custom package.json:**
<pre>
"scripts": {
    "start": "npm explore general-framework   -- npm run start",
    "build": "npm explore general-framework  -- npm run build",
    "prod": "npm explore general-framework  -- npm run prod",
    "logo": "npm explore general-framework -- npm run logo" 
},
</pre>

Loader Module (src/loading)
	
	HtmlPreloaderController
	This class is used for managing preloading video (brand logo) and progress bar.
	The class is created automaticaly in LoadManager.
	
	To use it please create in your games index.html in <body> </body> section
	<div class="gameLogo" id="gameLogo">
		<div class="video-container">
			<video autoplay muted playsinline>
				<source src="data/loader/video/logo_comp_640x360_w-sound_1000k.webm"
						type='video/webm; codecs="vp8, vorbis"'>
				<source src="data/loader/video/logo_comp_640x360_w-sound_1000k.mp4"
						type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
			</video>
			<div>
				<div id="logo-progress-bar">
					<svg viewBox="0 0 1500 150" xmlns="http://www.w3.org/2000/svg">
						<polygon fill="#ecbb41" points="0,150 31,0 1500,0 0,150"></polygon>
					</svg>
				</div>
			</div>
		</div>
	</div>
	
	and add logo video in folder data/loader/video/ 
	
	LoadManager
	This class is used to load:
		- all configs
		- i18n (localization)
		- assets (atlases) according to its loading priority
		- bitmap fonts according to its loading priority
		- spine data
		- sounds according to its loading priority
	
	Orders of loading: 

	"preload" - 
	all assets needed to show a preloader (a feature screen);

	“initial” - 
	all assets needed to start a game (without animations, features like freeGame, bigWin, etc)

	“lazy” - 
	all additional assets (animations, features like freeGame, bigWin, etc), that are loaded in background. 

	Lazy group consists of other groups, for example: “freeGame“, “bigWin”, “symbolAnimations“ etc.
	After all resources in current group are loaded, system dispatches event about it with groupID.

	Force loading
	Game can be launched only after all initial group is loaded. But other lazy groups can be in a loading process, when some game event is triggered (starts of free game, big win etc).
	We can check if needed group is loaded	 
	LoaderModel.isGroupLoaded(LazyLoadGroups.INFO)
	
	and if not loaded then start force loading this group.
	EventDispatcher.getInstance().dispatch(LoadEvent.FORCE_LOAD, LazyLoadGroups.INFO);	
	
	To use LoadManager please create in your games instance of class. 
	Override AssetsLoader, BitmapFontsLoader, SoundLoader to use certain loadres type (for slots we use PIXI.loader and howler libraries).
	
*/------------------------------------------------------------------------------------------------------------*/

MoneyFormatter (src/localization)
	/**
     * format money value
     * @param value - money value as number
     * @param showCurrency - true as default
     * return string 2500 => $2,500.00
     */
	 public static format(value: number, showCurrency: boolean = true): string
	 
	 /**
     * set precision - numbers of digits after dot
     * @param value
     */
    public static setPrecision(value: number): void 

    /**
     * set sign for currency
     * @param value
     */
    public static setCurrencySign(value: string): void 

*/------------------------------------------------------------------------------------------------------------*/

LocalUtil (src/localization)
	/**
    * create Dictionary from loaded data
    * @param data - loaded data
    */
    public static setDictionary(data: any): void
	
	/**
    * get text from Dictionary buy key
    * @param key - key in Dictionary
    */
    public static text(key: string): string

*/------------------------------------------------------------------------------------------------------------*/

AppLogger (src/logger)
	/**
     * Logs application message
     * @param message actual message to log
     * @param [type] optional type
     * @param [obj] optional data
     */
    public static log(message: string, type?: string, params?: any): void

*/------------------------------------------------------------------------------------------------------------*/

ServerRequest (src/server)
	Sending server request. For each request type create individual instance
	 /**
     * Create server reuest instance, incapsulating technical aspects
     * @param type ('init', 'spin', etc. Depends on server API)
     */
    constructor(type: string, prefix?: string)
	
	/**
     * This is a common method to fetch responses from server.
     * We have 3 possibilities to fetch with timeout 20 sec
     * @param body optional post parameters (Depends on server API)
     * @param params optional getParams to add in request
     */
    public fetch(body: any = {}, params: any = {}): Promise<any>

*/------------------------------------------------------------------------------------------------------------*/

DeviceInfoService (src/)	
	
	/**
     * Gets whether is landscape
     */
    public static get isLandscape(): boolean
	
	/**
     * Gets whether is full screen
     */
    public static get isFullScreen(): boolean
	
	/**
     * Gets whether is IOs
     */
    public static get isIOs()
	
	/**
     * Gets whether is desktop
     */
    public static get isDesktop(): boolean
	
	/**
     * Gets whether is mobile
     */
    public static get isMobile(): boolean

	/**
     * Gets userAgent string data
     */
    public static get userAgent(): string

    /**
     * Recieves array of devices and checks whether it matches current
     */
    public static setDeviceInfo(array: IDeviceInfo[]): void 
    
    /**
     * Gets whether its canvas-based
     */
    public static isCanvas(): boolean 

    /**
     * Gets device info data
     */
    public static getDeviceInfo(): IDeviceInfo
	
	/**
     * Check if browser use webGL and set @param isCanvas:boolean
     */
    public static detectWebGL(): void

IDeviceInfoService (src/interface)

	/**
	* Information about device
	* label stands for device name
	* pattern stands for device model
	*/
	interface IDeviceInfo {
		label: string,
		pattern: string
	} 
	
*/------------------------------------------------------------------------------------------------------------*/

EventDispatcher (src/)
	Global event dispatcher, based on eventemitter3.
	
	/**
     * Dispatchs event dispatcher
     * @param event
     * @param [options]
     * @param log
     */
    public dispatch(event: string, options?: any, log: boolean = true): void
	
	/**
	* Add a listener for a given event.
	*/
	on(event: EventTypes, fn: EventEmitter.ListenerFn, context?: any): this;
	addListener(event: EventTypes, fn: EventEmitter.ListenerFn, context?: any): this;

	/**
	* Add a one-time listener for a given event.
	*/
	once(event: EventTypes, fn: EventEmitter.ListenerFn, context?: any): this;

	/**
	* Remove the listeners of a given event.
	*/
	removeListener(event: EventTypes, fn?: EventEmitter.ListenerFn, context?: any, once?: boolean): this;
	off(event: EventTypes, fn?: EventEmitter.ListenerFn, context?: any, once?: boolean): this;

*/------------------------------------------------------------------------------------------------------------*/

GameInfo (src/)
	Storage for currency, lang, title, url, token.
	To init data, call 
	/**
     * Inits game information storage
     * Sets values from get params
     * Fetches token and notifies upon resolving
     */
    public static init(title: string)

*/------------------------------------------------------------------------------------------------------------*/

LocalStorage (src/)
	Util for storage data in a broser local storage.

	/**
     * storage[key] = value
     */
    public static setItem(key: string, value: string): void
	
	/**
     * value = storage[key]
     */
    public static getItem(key: string): string | null

*/------------------------------------------------------------------------------------------------------------*/

URLParams (src/)
	get parameters from url
	
	/**
	* get URL parameter by its key
	* @param key
	*/
	public static getParam(key: string): string

	/**
	* Returns a string representation of an url parameters.
	* Just a common util method
	* */
	public static toString(): any

*/------------------------------------------------------------------------------------------------------------*/
	
GoogleAnalytics (src/trackers)
	Store, retrieve event list from server. 
	Send data to Google Analytics.
	It may be expanded later with additional analytics systems.
	For now it remains as GoogleAnalytics.

	/**
     * Google analytics data is retrieved 
     * from initial server response.
	 * It has public getter and setter
     */
    private static _googleAnalyticsData: IGoogleAnalyticsData; 
	
	/**
     * This method is fired each time
     * any event occurs in the game,
     * but sends data to google only,
     * when there's eventList from server
     * and this is production build
     */
    public static postData(event?: string): void

*/------------------------------------------------------------------------------------------------------------*/

ClockService (src/clock)
	Service used to display user time 
	
	/**
	*Tick Up timeout with delay 1000 ms
	* */
	private static tickUp: any;
	
	 /**
     * @timeDataOptions
     * This field used to show time only or full date. Should be fill with server side and send with "ClockEvents.START_CLOCK" event.
     * Full option description at "ClockEvents.START_CLOCK" event
     */
    public static timeDataOptions = { second: "numeric", hour: "numeric", minute: "numeric"};
	
	 /**
     * Starts clock
     * @param [timeDataParams]
     */
    public static startClock(timeDataParams?: Object): void
	
	/**
     * Stops clock
     */
    public static stopClock(): void
	
	/**
     * Determines whether tick up on
     */
    private static onTickUp(): void
	
	 /**
     * @alertTimeOut()
     * This method is used to start any custom timer to dispatch incoming event.
     * @interval - time after timer stop in seconds
     * @event - event name which dispatched after timer stop
     * @repeats - number of cycles to repeat same timer
     * @loop - loop timer till application is open, if timer is loop, repeats are ignored
     */
    public static alertTimeOut(params: { interval?: number, event?: string, repeats?: number, loop?: boolean }): void

*/------------------------------------------------------------------------------------------------------------*/

ModalPopup (src/modalPopup)
	This class is used to manage incoming messages (errors, notifications, etc.)
	
	/**
     * To use modal first create instance:
     *      -> const modal = new ModalPopup()
     * than inject styles to html head tag:
     *      -> modal.insertPopupStyles([,yourStyles])
     * now you can use it with:
     *      -> dispatcher.dispatch(event [, dataWithTextButtons]);
     */
	
	/**
     * Calling view method to show modal popup
     * @param data
     */
    public showModalPopup(data: ModalPopupVO): void
	
	/**
     * Calling view method to hide modal popup
     */
    public hideModalPopup(): void
    
    /**
     * Injecting of prepared styles with the possibility of their modification
     * This method create style tag and insert in it prepared styles
     * It's possible to customize default styles for current project
     * @param styles
     */
    public insertPopupStyles(styles?: IModalPopupStyles): void
    
*/------------------------------------------------------------------------------------------------------------*/

ModalPopupView (src/modalPopup)
	Used to display incoming messages (errors, notifications, etc.)
	
	/**
     * Element that will be used as root for popup
     */
    public popupElement: HTMLDivElement;
	
    /**
     * Creating and inserting in DOM html structure with parsing existing data
     * on every colling it will be new HTML instance
     * @param {ModalPopupVO} data - object with texts and buttons to show in popup
     */
    public showPopup(data: ModalPopupVO): void
	
	/**
     * Hiding of opened popup
     * and deleting HTML popup structure
     */
    public hidePopup(): void
    
*/------------------------------------------------------------------------------------------------------------*/

const ModalPopupEvents (src/modalPopup/events)
	Events used to manage modal popup

*/------------------------------------------------------------------------------------------------------------*/

interface IModalPopupStyles (src/modalPopup/interfaces)
	Interface with a list of style props for customization modal popup 

*/------------------------------------------------------------------------------------------------------------*/

interface ModalPopupVO (src/modalPopup/interfaces)
	Interface of data to create modal popup view 

*/------------------------------------------------------------------------------------------------------------*/

ErrorServerModel (src/modalPopup/models)
	Parse, save and give the data from response on fetch error
		
	/**
     * Parse data from error
     * @param {object} data
     */
    public parseResponse(data): void
	
    /**
     * Clear all response values
     */
    public clear(): void
	
	/**
     * Getter to return body message
     * @returns {string}
     */
    get messageBody(): string
    
    /**
     * Getter to return header message
     * @returns {string}
     */
    get messageHeader(): string
    
    /**
     * Getter to return code from error
     * @returns {string} - must be the number as the initial type
     */
    get code(): string
    
    /**
     * Getter to return status from error
     * @returns {string} - must be the number as the initial type
     */
    get status(): string

*/------------------------------------------------------------------------------------------------------------*/

getModalPopupStyles (src/modalPopup/util)

    /**
     * Bring custom styles to inject them in project
     * @param {IModalPopupStyles} customStyles - styles from project to customize popup
     * @returns {string}
     */
    const getModalPopupStyles = (customStyles: IModalPopupStyles = {}): string

*/------------------------------------------------------------------------------------------------------------*/

ModalPopupUtil (src/modalPopup/util)
    Preparing text data from error to show in modal popup
    
    /**
     * If text data exists - returns it, otherwise returns stub
     * @param {string} code
     * @param {string} header
     * @param {string | Array.<string> } body
     * @returns {{header: string, body: string | string[]}}
     */
    public static getModalPopupData(code: string, header?: string, body?: string | string[]): ModalPopupVO

*/------------------------------------------------------------------------------------------------------------*/

/**
 * Constructor that init working reality check popup;
 * for viewing it use modal popup (see "modalPopup" module)
 * to start checking init constructor:
 *  -> new RealityCheck();
 *  after it, checking will trigger on some events (see constructor below)
 */
 
RealityCheck (src/reality-check)
	This class is used to manage reality check parametrs on server init events
	
	Managed parameters:
     * @param time_limit - The total time in seconds that the current game session can run before the player is shown a session time limit window. In seconds.
	 * @param time_elapsed - Amount of time in seconds since the user logged in.
	 * @param exit_URL - Exit game - it should exit to lobby url if one is provided, if there isn’t one provided then it should exit to a responsible gambling page.
	 * @param lobby_URL - Exit game - it should exit to lobby url if one is provided, if there isn’t one provided then it should exit to a responsible gambling page.
     

	  /**
     * This function starts on init event in game.
     * set inner params
     * @param params
     */
    private checkRealityOnInit(params: IRealityCheckParams): void
	
	/**
     * Starts regular check reality
     * Checking for:
     *  time limit is exists; otherwise - don't show popup,
     *  time elapsed more than time limit -> show reality check popup immediately
     */
    private setRealityCheckTimeout(): void
	
	/**
     * Starts the timer after which launch event of freeze game
     */
    private checkRealityRecursively(): void
	
	/**
     * Checks if user plays over 24 hours
     * @returns {boolean}
     */
    private checkOn24HoursExcess(): boolean
	
	
    /**
     * Change location with lobby url or url of responsible gambling page.
     * Update the operator that the user has selected an option in the reality check
     */
    private exitGame(): void
	
*/------------------------------------------------------------------------------------------------------------*/

RealityCheckData (src/reality-check)
	prepare and return data for reality check popup
	
	/**
     * Converts the difference when user started play with current time.
     * Called on every showing popup
     * @returns {string}
     */
    private static getTimeDiff(): string
    
     /**
     * Brings standard data for reality check popup
     * Called on every showing popup
     * @returns {{buttons: ({callback: () => void; text: string; class: string} | {callback: () => void; text: string; class: string} | {callback: () => void; text: string; class: string})[]; header: string; body: string[]}}
     */

    public static getData(): ModalPopupVO

*/------------------------------------------------------------------------------------------------------------*/

interface IRealityCheckParams (src/reality-check)
    Data received from operator
    
    Values:
        time_elapsed: number | string; // time spent from when user enter the game
        time_limit: number | string; // time for recursive shoving of RC popup
        exit_URL: string; // url to update operator about reality checking
        lobby_URL?: string; // url to exit from the current game to game lobby
        lang: string; // default language sent from operator

*/------------------------------------------------------------------------------------------------------------*/

RealityCheckModel (src/reality-check)
    Save and return values for reality checking
    
    getters/setters:
        time_elapsed(value: number): number;
        time_limit(value: number): number | null;
        exit_URL(value: string): string;
        lobby_URL(value: string): string;
        lang(value: string): string;
        isFrozen(value: boolean): boolean;
        startTime(value: number): number;

*/------------------------------------------------------------------------------------------------------------*/

WindowService (src/window)
	Service to manage window environment
	
	/**
     * Inits window service
     */
    public static init(): void
	
	/**
     * Enables full screen
     */
    public static enableFullScreen()
	
	
    /**
     * Gets whether is full screen
     */
    public static get isFullScreen(): boolean 
    
    
Changelog
	ALIB-263 classs EventDispatcher add GoogleAnalytics post method
	
	21/020/2020
	SFF-33 isabling the logger in the console on the production server
	class AppLogger check process.env.NODE_ENV === 'production'
    ___________________________________________________________	
	
	25/02/2020  
	ALIB-427 - iPad issues
	issue with iPad with iOS 13+ version not detected as mobile 
	class DeviceInfoService check public static get isMobile()
	___________________________________________________________
	
	27/02/2020  
    ALIB-427 - iPad issues
    detect desktop change
    class DeviceInfoService refactoring public static get isDesktop()
    ___________________________________________________________
	
	27/02/2020
	ALIB-473 game freezes after intro video
	rel-prepare.js
	add atlasExtension property (in assets_config.json)
	___________________________________________________________
    	
	26/03/2020
	ROUL-443 The game freezes after clicking on "X" 
	ModalPopupView.ts 
	add emit function delegate
	remove direct call of public hidePopup(): void 
	emit event this.emit(ModalPopupEvents.HIDE_MODAL_POPUP);
	ModalPopupView.ts 
	register delegate protected onViewEmit(event: string): void
	___________________________________________________________
	
	13/03/2020
	FGFW-62 Send ping for every delta second to the operator while the game is open
	added PingController.ts, IOperatorPingData.ts 
	___________________________________________________________
	
	06/04/2020
	FGFW-61 Certification for Italy
	added AdditionalInfoController.ts, AdditionalInfoCSS.ts, AdditionalInfoLocalization.ts, IAdditionalInfoData.ts, ImageBase64Constatnts.ts.
	To show popup - please dispatch from game event "RootViewEvents.ADD_ROOT_VIEW_TO_STAGE".
	To pose it - call a static method  AdditionalInfoController.setPosition(x, y);
	___________________________________________________________
	
	09/04/2020
    FGFW-62 Send ping for every delta second to the operator while the game is open
    get data for PingController.ts from skinParams
    ___________________________________________________________
    
    13/04/2020
    FGFW-62 Send ping for every delta second to the operator while the game is open
    class AdditionalInfoController.ts - add JSON.parse() for skin_params
    ___________________________________________________________
    
    27/04/2020
    MERM-207 Game crashes with wrong language key &lang=
    class GameInfo add param _defaultLang as 'en' 
    class LoadManager method loadI18N() rebuild according to issue
    ___________________________________________________________
    
    24/06/2020
    FGFW-72 Custom messages from operator (CMA)
    this task implimentation is based on custom messages response from server
    custom messages responce interface is described at ICustomMessage
    class CustomMessageModel - new class constaractor for incoming custom messages
    class ServerRequest - add param currentRequestType:string to detect request type
    class ServerRequest - method innerResolve - refactoring. Custom message response check included. CUSTOM_ALL_MESSAGES_SHOW_COMPLETE event listenner added, to detect user action and continue game
    class CommonInitServerResponse - new class to parse game settings and operator settings on init response 
    class ServerConstatnts - new const class with server reqest types 
    class ModalPopupController - new class to manage custom messages flow
    ___________________________________________________________
   
    15/09/2020
    INTE-515 build for bin_prod on SOTH fail
    package.json 
    - @types/node : 14.10.1 version frize
    - typescript : 3.5.3 version frize
    ___________________________________________________________
    
    22/09/2020  
    GOLD-509 - Reality check changes + fix check app in few tabs:
    - added opportunity use freeze time on RC popup shown for user. The time shoud count only user play
    - RC "start time" are saving in session storeage - after page refresh the time should count from the previous state
    - fixed bug on trying to write in local storage when app placed inside iframe on "incognito" mode
    ___________________________________________________________
    
    24/09/2020  
    GOLD-503 - Reality check changes:
    - the remaining time before need to show the RC popup would save to the session storage and will be considered if user reload the page (time limit [- time elapsed] - notExpiredLimitTime)
    ___________________________________________________________

    23/10/2020
    INTE-487 - APIController changes:
    - extended APIData with autospinstop data
    ___________________________________________________________

    03/12/2020
    SFF-83 - Added stake and win amount on messages for malta (not only).
    Provide ‘rcInfoUrl’ in ‘skin_params’, otherwise, no additional info will be shown.
    While realityCheck, 'generateBetWinData' method will asynchronously wait for data retrive from given url (rcInfoUrl) and adding in to the popup.
    The JSON format should be as next:
    {
        "currencyCode": “USD”,
        "currencySymbol": “$”,
        "totalBet": “50.00”,
        "totalWin": “60.00"
    }
   ___________________________________________________________
   
    17/01/2021 
    GODS-227 - Create new loader which will include two loader we had before
   
    LoaderModel.ts: 
     - now includes new priority data to load "general"
    protected static _generalSoundsToLoad: IAssetsGroup[];
    protected static _generalAssetToLoad: IAssetsGroup[];
   
     - new geter setter for spine data
    private static _spineDataToLoad: number;  
    
    LoaderManager.ts:
     - loadSpineData now have unnessery incoming parameter
    protected loadSpineData(priority: string = "")
     
    SoundLoader.ts:
     - added similar behaviar for LoaderConstants.GENERAL_PRIORITY as for LoaderConstants.PRELOAD_PRIORITY

    AssetsLoader.ts:
     - added similar behaviar for LoaderConstants.GENERAL_PRIORITY as for LoaderConstants.PRELOAD_PRIORITY
   
    ConfigLoader.ts:
     - added unnessery incoming parameter "priority"
        public loadSpineData(data: { url: string, isCommon: boolean }[], priority: string)
        public loadSpineConfig(data: string, priority: string)
        protected parseSpineData(data: any, id: string, priority: string)
    
    ISoundsLoader.ts, IAssetsToLoad.ts:
     - general: IAssetsGroup[] priority added
     
    LoadEvents.ts:
     - all general data loaded event added     
        PROJECT_LOADING_COMPLETE: "LoadEvents.PROJECT_LOADING_COMPLETE"
     
    LoaderConstants.ts:
     - new priority addded      
        GENERAL_PRIORITY: "general",
    ___________________________________________________________
    
    17/01/2021 
    new npm script "copy-data" added to package.json
     - helps to copy data to different local projects
     - use "copy-local-data.json" to copy exported data to other projects
        description:
            path[
                {
                  "to": "path of your other local project\\node_modules\\general-framework\\lib",
                  "from": "lib"  // this project "lib" folder
                },
                {
                  "to": "path of your other local project\\node_modules\\general-framework\\src",
                  "from": "src" // this project "src" folder
                },    
            ]
         all data in "to" directory, will be overwrited with "from"
    ___________________________________________________________
    
    25/01/2021 
    FGFW-86 - Hide token from url
     - adds removing "platform_token" get param from URL on GameInfo.init
     - uses history.state instead of get param for storing token on client
     - changes getter of token in GameInfo class
    ___________________________________________________________
    
    25/01/2021 
    FGFW-93 - Show decimal for values less than 100 in balance
       MoneyFormatter.ts:
           - @param minInteger - minimum integer number, where digits after dot will not show
              added to format()
           - defaultMinInteger - equls to 100  
    ___________________________________________________________
