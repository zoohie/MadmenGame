import {IPingData} from "./IPingData";
import {AppLogger} from "../logger/AppLogger";

export class PingController {
    /**
     * data from operator
     * In front.settings.operator_ping
     */
    private static _data: IPingData;

    static get data(): IPingData {
        return this._data;
    }

    static set data(value: IPingData) {
        this._data = value;
    }

    /**
     * start ping timer
     */
    public static startPing(): void {
        if (this.data && this.data.url && this.data.url.length > 0) {
            this.startPingTimer();
            window.onclose = this.ping.bind(this);
        }
    }

    private static startPingTimer(): void {
        setTimeout( this.ping.bind(this), this.data.time_elapsed);
    }

    /**
     * send ping message
     */
    private static ping(): void {
        const xhr = new XMLHttpRequest();

        xhr.open(this.data.method, this.data.url, true);
        xhr.setRequestHeader("Content-Type", this.data.data_type);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                AppLogger.log("Ping success")
            }
        };
        xhr.send(this.data.send_parameters);
        this.startPingTimer();
    }
}
