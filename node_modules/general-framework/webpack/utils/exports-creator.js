const fs = require('fs');
const path = require('path');
const walk = require('./walk');

const currentDir = path.join(__dirname, '..', '..');

const dirPath = path.join(currentDir, 'src');
const indexJsPath = path.join(currentDir, 'lib', 'index.js');
const indexDTsPath = path.join(currentDir, 'lib', 'index.d.ts');

(() => {
    walk(dirPath, null, (err, files) => {
        if (err) throw err;

        let imports = '';
        let exports = '';

        files
            .filter((file) => ~fs.readFileSync(file, {encoding: 'utf-8'})
                .search(/export (class|interface|function|abstract|let|const)/))
            .forEach((file) => {
                const url = file.split('src' + path.sep)[1].replace(/\.ts$/, '').replace(/\\/g, '/');
                const arr = url.split('/');
                const key = arr[arr.length - 1];

                imports += `import {${key}} from './${url}';\n`;
                exports += `  ${key},\n`;
            });

        const output = imports + `\nexport {\n${exports}}`;

        fs.writeFile(indexJsPath, output, (err) => {
            if (err) throw err;
            fs.writeFile(indexDTsPath, output, (err) => {
                if (err) throw err;
                console.log('finish export creator');
            })
        })
    })
})();
